<!DOCTYPE html>
<html>
<head>
    <title>Node.js Webpage Example</title>
    <link href='https://fonts.googleapis.com/css?family=Outfit' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="./style/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body style="margin: 50px">
<h1>Catalogo film</h1>
<form>
    <div class="container mt-5 text-center shadow p-3 mb-5 bg-body-tertiary rounded">
        <div class="row mb-2">
            <div class="col mb-2">
                <h3>Filtri</h3>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col mb-2">
                <select class="form-select" aria-label="Disabled select example" >
                    <option selected>Genere</option>
                    <option value="1">Comedy</option>
                    <option value="2">Action</option>
                    <option value="3">Adventure</option>
                    <option value="4">Drama</option>
                    <option value="5">Sports & Fitness</option>
                    <option value="6">Science Fiction & Fantasy</option>
                    <option value="7">Romance</option>
                </select>
            </div>
            <div class="col mb-2">
                <select class="form-select" aria-label="Disabled select example">
                    <option selected>Anno</option>
                    <option value="1">2000</option>
                    <option value="2">2001</option>
                    <option value="3">2002</option>
                </select>
            </div>
            <div class="col mb-2">
                <select class="form-select" aria-label="Disabled select example">
                    <option selected>Direttore</option>
                    <option value="1">Tim Burton</option>
                    <option value="2">Michel Gondry</option>
                    <option value="3">Ivan Reitman</option>
                    <option value="4">William Wyler</option>
                    <option value="5">John Woo</option>
                    <option value="6">Steven Spielberg</option>
                </select>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col">
                <select class="form-select" aria-label="Disabled select example" disabled>
                    <option selected>Open this select menu</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option>
                </select>
            </div>
            <div class="col">
                <select class="form-select" aria-label="Disabled select example">
                    <option selected>Open this select menu</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option>
                </select>
            </div>
            <div class="col">
                <select class="form-select" aria-label="Disabled select example">
                    <option selected>Open this select menu</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option>
                </select>
            </div>
        </div>
    </div>
    <div class="row mb-2  align-items-center ">
        <div class="col-md-6 align-self-center">
            <button type="submit" class="btn btn-primary">Filtra</button>
        </div>

    </div>

</form>
<a href="/insertFilm">
    <button type="button" class="btn btn-primary float-end "
            style="border-radius: 50%; bottom: 50px; position: fixed; right: 50px; z-index: 10000; width: 80px; height: 80px; font-size: 50px;">+
    </button>
</a>

<input type="text" id="searchInput" placeholder="Search by title, director, or genre">
<button id="searchButton" class="btn btn-primary">Search</button>

<ul id="itemList"></ul>
<div id="pagination"></div>

<script>
    let currentPage = 1;
    const itemsPerPage = 10;

    const searchButton = document.getElementById('searchButton');
    searchButton.addEventListener('click', () => {
        currentPage = 1; // Reset current page to 1 when searching
        fetchItems();
    });

    async function fetchItems() {
        const response = await fetch('/items');
        const allItems = await response.json();
        const sortByName = (a, b) => a.name > b.name;
        allItems.sort(sortByName);

        const searchInput = document.getElementById('searchInput').value.toLowerCase().trim();
        let filteredItems = allItems.filter(item => {
            const includesSearch = (
                item.name.toLowerCase().includes(searchInput) ||
                item.directors.toLowerCase().includes(searchInput) ||
                item.genres.toLowerCase().includes(searchInput)
            );
            return includesSearch;
        });

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const items = filteredItems.slice(startIndex, endIndex);

        const itemList = document.getElementById('itemList');
        itemList.innerHTML = '';

        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'item';
            // Creazione del titolo
            const title = document.createElement('h2');
            title.textContent = item.name;
            li.appendChild(title);

            // Creazione delle informazioni
            const info = document.createElement('p');
            info.textContent = item.info;
            li.appendChild(info);

            // Creazione dei generi
            const genres = document.createElement('p');
            genres.textContent = 'Genres: ' + item.genres;
            li.appendChild(genres);

            // Creazione dei registi
            const directors = document.createElement('p');
            directors.textContent = 'Directors: ' + item.directors;
            li.appendChild(directors);

            const ratingsDiv = document.createElement('div');

            const rottenRating = document.createElement('p');
            rottenRating.textContent = `Rotten Tomatoes: ${item.ratings.rotten_rating}`;
            ratingsDiv.appendChild(rottenRating);

            const netflixRating = document.createElement('p');
            const netflixValue = parseFloat(item.ratings.netflix_rating);
            netflixRating.textContent = `Netflix: ${netflixValue.toFixed(1)}/5`;
            ratingsDiv.appendChild(netflixRating);

            const imdbRating = document.createElement('p');
            const imdbValue = item.ratings.imdb_rating;
            imdbRating.textContent = `IMDb: ${imdbValue.toFixed(1)}/10`;
            ratingsDiv.appendChild(imdbRating);

            li.appendChild(ratingsDiv);

            const editButton = document.createElement('button');
            editButton.className = 'large';
            editButton.textContent = 'Edit';
            editButton.addEventListener('click', function() {
                const dataJSON = encodeURIComponent(JSON.stringify(item));
                window.location.href = `updateFilm?data=${dataJSON}`;
            });

            const removeButton = document.createElement('button');
            removeButton.className = 'large';
            removeButton.textContent = 'Remove';
            removeButton.addEventListener('click', () => removeItem(item._id));

            li.appendChild(editButton);
            li.appendChild(removeButton);

            itemList.appendChild(li);
        });

        createPaginationButtons(allItems.length);
    }

    function createPaginationButtons(totalItems) {
        const numPages = Math.ceil(totalItems / itemsPerPage);
        const paginationContainer = document.getElementById('pagination');

        paginationContainer.innerHTML = '';

        for (let page = 1; page <= numPages; page++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = page;
            pageButton.addEventListener('click', () => {
                currentPage = page;
                fetchItems();
            });

            paginationContainer.appendChild(pageButton);
        }
    }

    async function removeItem(itemId) {
        await fetch('/removeItem', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `id=${itemId}`
        });
        await fetchItems();
        alert("Deletion completed")
    }

    fetchItems();


</script>
</body>
</html>
